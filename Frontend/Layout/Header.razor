@using Frontend.Layout;
@inject Frontend.Services.CartService CartService
@inject Frontend.Shared.CartState CartState
@inject NavigationManager Navigation
<style>
    svg{
    text-align: center;
    }
</style>
<MudStack Spacing="0">
    <!--

    <MudPaper>
    Ofertas #1
    </MudPaper>
    -->

    <MudPaper>
        <!-- Barra Superior -->
        <MudAppBar 
            Fixed="false"
            Elevation="8"
            Style="height:75px; background:black;">

            <svg width="84" height="19" viewBox="0 0 84 19" xmlns="http://www.w3.org/2000/svg" class="vivint-logo" aria-labelledby="vivint-logo-title" role="img" style="">
                <title id="vivint-logo-title">Vivint Logo</title>
                <path d="M8.42795 18.4524C6.05688 18.4524 3.68581 18.4533 1.31474 18.4507C1.10591 18.4504 0.895373 18.441 0.688832 18.4133C0.297748 18.361 0.0797813 18.1336 0.0389304 17.7451C0.0169337 17.5374 0.00207879 17.3277 0.00179312 17.1189C-0.000492246 14.3764 -0.000492246 11.634 0.00122178 8.89156C0.00150745 8.65388 0.0292176 8.41563 0.0237898 8.17824C0.0135056 7.7026 0.240043 7.34379 0.569707 7.03641C1.5767 6.09712 2.58969 5.16412 3.59611 4.22398C4.72565 3.16842 5.84948 2.10687 6.97817 1.05046C7.27527 0.7725 7.57836 0.501112 7.88175 0.23001C8.22312 -0.0750864 8.6382 -0.0770861 8.9753 0.236295C10.4205 1.57838 11.8611 2.9256 13.3055 4.26854C14.2648 5.16041 15.2318 6.04399 16.1862 6.941C16.3696 7.11326 16.5287 7.31865 16.6667 7.52977C16.8678 7.83743 16.8518 8.20281 16.8575 8.55076C16.871 9.36949 16.8624 10.1885 16.8624 11.0075C16.8624 13.0167 16.8644 15.0258 16.8601 17.0352C16.8595 17.2909 16.8353 17.5471 16.8061 17.8016C16.769 18.127 16.5519 18.3564 16.2236 18.4064C16.0082 18.4393 15.788 18.4507 15.5697 18.451C13.1889 18.4535 10.8084 18.4524 8.42795 18.4524ZM8.45823 14.7992C9.8863 14.7992 11.3144 14.8001 12.7424 14.799C13.2529 14.7987 13.2532 14.7964 13.2535 14.3033C13.2535 12.6944 13.2506 11.0855 13.2569 9.47662C13.2578 9.26979 13.1972 9.12353 13.043 8.98098C11.5772 7.62747 10.1183 6.26624 8.65734 4.9073C8.44566 4.71048 8.40624 4.71162 8.19141 4.91302C6.80562 6.21225 5.4244 7.51634 4.03004 8.80586C3.75894 9.05668 3.63467 9.31864 3.63924 9.69487C3.65781 11.2178 3.64696 12.7413 3.64696 14.2645C3.64696 14.3407 3.64553 14.417 3.65153 14.4927C3.66952 14.721 3.72323 14.7772 3.94577 14.7941C4.05004 14.8021 4.15517 14.799 4.25972 14.799C5.65922 14.7995 7.05873 14.7995 8.45823 14.7992Z" fill="white"></path>
                <path d="M66.0977 6.6261C66.1902 6.51097 66.2793 6.39299 66.3753 6.28072C66.7861 5.80079 67.3192 5.51341 67.8985 5.2843C68.7398 4.95207 69.618 4.94464 70.4821 5.05119C71.5731 5.18574 72.5233 5.67024 73.2212 6.54782C73.5434 6.95319 73.7831 7.41541 73.9573 7.91105C74.2433 8.72464 74.3733 9.55708 74.3701 10.4192C74.3613 12.9331 74.367 15.4471 74.367 17.961C74.367 17.999 74.3673 18.0372 74.3667 18.0752C74.363 18.4206 74.3456 18.4466 73.9916 18.4483C73.0298 18.4532 72.0682 18.4532 71.1063 18.4489C70.737 18.4475 70.7118 18.4149 70.7118 18.0298C70.7113 15.735 70.7118 13.4399 70.711 11.1451C70.711 10.8786 70.7252 10.6095 70.6944 10.3458C70.6144 9.66593 70.3799 9.06402 69.796 8.64008C69.5343 8.44982 69.2343 8.35469 68.9358 8.30813C68.2659 8.20357 67.6094 8.26471 67.0332 8.67922C66.6896 8.92632 66.439 9.24513 66.2656 9.63564C66.0362 10.1513 65.9931 10.6866 65.996 11.2425C66.0074 13.4802 66.0008 15.7182 66.0008 17.9558C66.0008 18.0321 65.9942 18.1087 66.0014 18.1844C66.0197 18.374 65.9174 18.4403 65.748 18.444C65.6717 18.4457 65.5957 18.4509 65.5197 18.4509C64.6247 18.4515 63.7294 18.4515 62.8344 18.4509C62.7585 18.4509 62.6822 18.4466 62.6062 18.4446C62.4336 18.44 62.3405 18.3606 62.3491 18.1789C62.3531 18.0935 62.3479 18.0075 62.3479 17.9218C62.3479 13.8844 62.3479 9.84676 62.3477 5.80936C62.3477 5.22517 62.3534 5.3063 62.865 5.30373C63.7792 5.29944 64.6933 5.30144 65.6074 5.30315C65.9954 5.30401 65.9991 5.30944 66.0002 5.70795C66.0014 5.99191 66.0005 6.27558 66.0005 6.55954C66.0331 6.58211 66.0654 6.6041 66.0977 6.6261Z" fill="white"></path>
                <path d="M29.1006 13.9566C29.3608 13.247 29.6002 12.6151 29.8242 11.9778C30.0236 11.4101 30.1984 10.8342 30.3978 10.2666C30.5966 9.70011 30.8177 9.14133 31.0188 8.57513C31.1785 8.12549 31.3162 7.66841 31.4748 7.21848C31.6279 6.78483 31.795 6.35633 31.957 5.92611C32.0133 5.77699 32.0884 5.63272 32.1264 5.47932C32.167 5.3162 32.2758 5.3042 32.4052 5.3042C32.6337 5.3042 32.8623 5.30306 33.0905 5.30306C33.9284 5.30277 34.766 5.30277 35.6039 5.30334C35.6896 5.30334 35.7758 5.3002 35.8607 5.3082C36.0369 5.32477 36.0695 5.3699 36.0112 5.52331C35.8804 5.86611 35.7458 6.20721 35.611 6.5483C35.4102 7.05565 35.2088 7.56272 35.0057 8.0695C34.7957 8.5937 34.5812 9.1162 34.3732 9.64126C34.1721 10.1492 33.9795 10.6608 33.7787 11.169C33.5296 11.7992 33.2734 12.4263 33.0251 13.0567C32.8257 13.5632 32.6352 14.0734 32.4372 14.5808C32.2458 15.0716 32.0504 15.5609 31.8567 16.0506C31.6913 16.4688 31.5256 16.887 31.3594 17.305C31.2242 17.6446 31.0914 17.9851 30.948 18.3214C30.9269 18.3708 30.8569 18.4151 30.8009 18.4305C30.72 18.4525 30.6312 18.4505 30.5458 18.4508C29.5939 18.4519 28.6418 18.4536 27.6899 18.4502C27.2997 18.4488 27.284 18.4214 27.1417 18.0508C26.9435 17.5341 26.7272 17.0241 26.5235 16.5094C26.3201 15.9952 26.1264 15.4769 25.9225 14.963C25.6836 14.3611 25.4374 13.7621 25.1966 13.161C24.9943 12.6565 24.7958 12.1506 24.5952 11.6455C24.4393 11.2527 24.2824 10.8602 24.1265 10.4674C23.9222 9.95264 23.7182 9.43758 23.5143 8.92251C23.3203 8.4323 23.1272 7.9418 22.9318 7.45216C22.7224 6.92824 22.5101 6.40518 22.3004 5.88154C22.2513 5.75927 22.197 5.63786 22.1625 5.51131C22.1288 5.3879 22.1787 5.30734 22.3202 5.30706C22.4059 5.30706 22.4916 5.30363 22.577 5.30363C23.5671 5.30334 24.557 5.30334 25.5471 5.30334C26.0747 5.30334 26.0653 5.30649 26.2253 5.79784C26.391 6.30748 26.5809 6.80883 26.7538 7.31618C26.9475 7.88467 27.1271 8.45772 27.3248 9.0245C27.5259 9.60184 27.7459 10.1726 27.9493 10.7494C28.1059 11.193 28.2475 11.6421 28.399 12.0877C28.5018 12.3906 28.6095 12.6914 28.7158 12.993C28.7875 13.1964 28.8572 13.4007 28.9343 13.6021C28.974 13.7046 29.0277 13.8018 29.1006 13.9566Z" fill="white"></path>
                <path d="M48.7203 13.9057C48.8094 13.6846 48.9048 13.4655 48.9865 13.2416C49.1154 12.8888 49.2371 12.5331 49.3579 12.1774C49.509 11.7321 49.6516 11.2839 49.8067 10.8402C49.921 10.5137 50.0541 10.1937 50.1707 9.86778C50.2781 9.56697 50.3718 9.2613 50.4763 8.95935C50.5932 8.62254 50.7177 8.28831 50.8351 7.95178C50.94 7.65154 51.0371 7.34845 51.1425 7.04821C51.3076 6.57856 51.5184 6.12006 51.6304 5.63813C51.711 5.29104 51.9047 5.2999 52.1624 5.30133C53.2191 5.30733 54.276 5.30276 55.3327 5.30476C55.6533 5.30533 55.6984 5.39131 55.5784 5.68041C55.3587 6.21033 55.1545 6.74682 54.9419 7.27989C54.75 7.76153 54.5551 8.24231 54.3617 8.72367C54.1549 9.23873 53.9489 9.75408 53.7407 10.2686C53.5324 10.7834 53.3193 11.2959 53.1128 11.8112C52.9134 12.3094 52.7217 12.8111 52.5234 13.3098C52.2698 13.9477 52.0095 14.5828 51.7578 15.2215C51.5584 15.7278 51.3705 16.2385 51.1728 16.7453C50.9848 17.227 50.7963 17.7086 50.5972 18.1857C50.5252 18.3582 50.4038 18.4579 50.1849 18.4553C49.2045 18.4431 48.2232 18.4336 47.2434 18.4582C46.8714 18.4676 46.8189 18.2111 46.7232 17.9774C46.4029 17.1964 46.089 16.4128 45.7793 15.6275C45.5348 15.0073 45.3054 14.3811 45.0591 13.7615C44.8163 13.1513 44.5561 12.5479 44.3127 11.9378C44.111 11.4324 43.9265 10.9202 43.7276 10.4137C43.5802 10.0378 43.4191 9.66724 43.27 9.29187C43.0614 8.76795 42.8603 8.24088 42.6524 7.71668C42.5001 7.33216 42.3413 6.94994 42.187 6.56599C42.0433 6.20805 41.8999 5.84982 41.7614 5.48958C41.7245 5.3936 41.7534 5.31875 41.8716 5.31104C41.9476 5.30618 42.0239 5.30418 42.0999 5.30418C43.1471 5.3039 44.1944 5.30333 45.2417 5.30418C45.6182 5.30447 45.6502 5.33932 45.7745 5.70841C45.9393 6.19805 46.1218 6.68169 46.2901 7.1699C46.4461 7.62241 46.5866 8.08034 46.746 8.5317C46.9469 9.09933 47.1645 9.66095 47.3665 10.228C47.5245 10.6717 47.665 11.1216 47.8216 11.5661C48.0184 12.1252 48.2244 12.6814 48.4252 13.2393C48.5018 13.4518 48.5746 13.6661 48.6492 13.8795C48.6732 13.888 48.6969 13.8969 48.7203 13.9057Z" fill="white"></path>
                <path d="M77.1689 12.1266C77.1689 11.1745 77.1698 10.2223 77.1684 9.27019C77.1681 8.95653 77.1638 8.95167 76.8487 8.95024C76.3251 8.94767 75.8014 8.95167 75.2778 8.94796C75.0215 8.94624 75.003 8.92939 75.0024 8.66828C74.9993 7.64958 74.9993 6.63088 75.0021 5.61189C75.003 5.33622 75.035 5.30708 75.3223 5.30451C75.8366 5.30022 76.3508 5.30508 76.8647 5.30079C77.1609 5.29851 77.1675 5.28994 77.1681 4.9917C77.1695 3.94443 77.1681 2.89716 77.1692 1.8496C77.1695 1.50651 77.1712 1.50422 77.5194 1.50365C78.4716 1.50251 79.4237 1.50222 80.3759 1.50365C80.7287 1.50422 80.7484 1.52222 80.7492 1.87617C80.7518 2.82831 80.7504 3.78045 80.7507 4.73259C80.7507 4.8183 80.7481 4.90428 80.7527 4.9897C80.7672 5.25937 80.8052 5.29908 81.0809 5.30079C81.6808 5.30422 82.2804 5.30222 82.8803 5.30251C83.0803 5.30251 83.2803 5.30222 83.4803 5.30251C83.9893 5.30336 83.9985 5.31108 83.9993 5.835C84.0007 6.63488 83.9999 7.43447 83.9996 8.23435C83.9996 8.35805 84.0019 8.48203 83.9962 8.60572C83.9816 8.91653 83.9508 8.94796 83.6439 8.94853C82.8061 8.95024 81.9682 8.94853 81.1303 8.94967C80.7889 8.95024 80.7524 8.98224 80.7518 9.32533C80.7495 10.7725 80.7461 12.2197 80.7558 13.667C80.7578 13.9698 80.7907 14.2772 80.8507 14.574C80.9186 14.9108 81.1572 15.1236 81.4688 15.2581C81.7462 15.3778 82.0382 15.3944 82.3339 15.3921C82.629 15.3898 82.9246 15.3967 83.2192 15.3801C83.378 15.371 83.5345 15.3213 83.6919 15.2893C83.8936 15.2484 83.9542 15.2864 83.9865 15.4861C83.9985 15.5607 83.9987 15.6378 83.9987 15.7141C83.9996 16.3805 84.0013 17.047 83.9982 17.7135C83.9965 18.1043 83.971 18.1371 83.6017 18.2648C83.1435 18.4234 82.675 18.5297 82.1867 18.5414C82.0645 18.5442 81.9433 18.5882 81.8211 18.5911C81.5191 18.5979 81.2169 18.5962 80.9149 18.5888C80.8021 18.5859 80.6904 18.5482 80.5775 18.5414C79.8671 18.4988 79.2478 18.234 78.6707 17.8238C78.1202 17.4321 77.732 16.9165 77.5 16.3028C77.338 15.8741 77.2155 15.4084 77.1932 14.9536C77.1469 14.0135 77.1792 13.0693 77.1792 12.1266C77.1761 12.1266 77.1724 12.1266 77.1689 12.1266Z" fill="white"></path>
                <path d="M60.3182 11.8676C60.3182 13.8765 60.3182 15.8856 60.318 17.8944C60.318 17.999 60.3168 18.1038 60.312 18.2084C60.3062 18.3321 60.2345 18.3995 60.1154 18.4135C60.04 18.4221 59.9634 18.4215 59.8874 18.4215C58.9544 18.4221 58.0214 18.4226 57.0882 18.4215C56.6745 18.4209 56.6728 18.4186 56.6728 18.0101C56.6725 14.297 56.6725 10.5838 56.6725 6.87066C56.6725 6.47072 56.6705 6.07078 56.6736 5.67113C56.6759 5.35375 56.7039 5.32147 57.0147 5.32061C58.0049 5.31747 58.995 5.31775 59.9851 5.32061C60.2991 5.32147 60.3171 5.34204 60.3174 5.66999C60.3188 7.38373 60.3182 9.09747 60.3182 10.8112C60.3182 11.1632 60.3182 11.5154 60.3182 11.8676Z" fill="white"></path>
                <path d="M37.117 11.8658C37.117 9.89615 37.117 7.92673 37.117 5.95703C37.117 5.88104 37.1167 5.80476 37.117 5.72878C37.1187 5.33084 37.129 5.31912 37.5406 5.31798C38.1591 5.31627 38.7776 5.31741 39.3961 5.31769C39.7292 5.31798 40.0623 5.31341 40.3951 5.32141C40.633 5.32712 40.6699 5.37197 40.6799 5.61279C40.6827 5.67935 40.6807 5.74592 40.6807 5.81248C40.6807 9.86587 40.6807 13.9193 40.6807 17.9726C40.6807 18.42 40.6804 18.4203 40.2259 18.4206C39.3221 18.4209 38.4179 18.4211 37.5141 18.4203C37.1178 18.42 37.1167 18.4186 37.1167 18.0318C37.1167 15.9764 37.117 13.921 37.117 11.8658Z" fill="white"></path>
                <path d="M60.6309 2.18861C60.7117 3.37957 59.6147 4.37828 58.4812 4.34257C57.2291 4.30314 56.3358 3.42671 56.3167 2.16661C56.2992 1.0225 57.2131 0.0135068 58.542 8.0288e-05C59.579 -0.0102039 60.7243 0.968791 60.6309 2.18861Z" fill="white"></path>
                <path d="M38.9127 0.0130973C40.0768 -0.0668906 41.0992 1.04694 41.071 2.19648C41.0407 3.43172 40.0908 4.34673 38.8879 4.34159C37.7129 4.33673 36.751 3.40944 36.7233 2.16906C36.6988 1.07465 37.7246 -0.0586061 38.9127 0.0130973Z" fill="white"></path>
                <path d="M20.0381 18.4191C18.8488 18.4988 17.8398 17.3956 17.8627 16.2809C17.8884 15.0268 18.8068 14.1106 20.0481 14.0992C21.2076 14.0886 22.176 14.9639 22.1986 16.3043C22.2169 17.3924 21.2565 18.4946 20.0381 18.4191Z" fill="white"></path>
            </svg>
            
            <AuthorizeView Roles="Normal">
                <Authorized>
                    <MudIconButton 
                        Class="ml-8"
                        Icon="@Icons.Material.Filled.Menu" 
                        Color="Color.Inherit" 
                        OnClick="@(() => OpenDrawer(Anchor.Start))" />

                    <MudText Typo="Typo.h6" Align="Align.Center" Class="ml-3">
                        Admin Panel
                    </MudText>
                </Authorized>
            </AuthorizeView>

            <MudSpacer />
            <MudMenu 
                    Label="Login"
                    Icon="@Icons.Material.Filled.AccountCircle"
                    Color="Color.Inherit"
                    AnchorOrigin="Origin.BottomRight"
                    TransformOrigin="Origin.TopRight">
                <Frontend.Shared.AuthLinks />

            </MudMenu>

            <MudBadge  
                Origin="Origin.BottomRight"
                Visible="@HasItems"
                Content="@CartItemCount"
                Color="Color.Error" 
                Overlap="true" 
                Bordered="true">
                    <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Inherit" @onclick="@GoToCart" />
            </MudBadge>

        </MudAppBar>
        <!-- Fin Barra Superior -->

        <!------------------------------------------------------------------------------------------------------>
        <!---- Barra lateral ----------------------------------------------------------------------------------->
        <!------------------------------------------------------------------------------------------------------>
        <AuthorizeView Roles="Normal">
            <Authorized>

                <MudDrawer 
                    @bind-Open="@_open" 
                    Anchor="@_anchor" 
                    Elevation="1" 
                    Variant="@DrawerVariant.Temporary" 
                    OverlayAutoClose="@_overlayAutoClose">

                    <NavMenu />

                </MudDrawer>
            </Authorized>
        </AuthorizeView>
        <!--
            OnClick="@(() => OpenDrawer(Anchor.Start))"
        <div style="width:250px position: relative;">
        <MudDrawer 
        @bind-Open="@_drawerOpen" 
        ClipMode="DrawerClipMode.Always"
        >
        <NavMenu />
        </MudDrawer>
        </div>
        -->
        
        <!------------------------------------------------------------------------------------------------------>
        <!-- Fin Barra Lateral -->
        <!------------------------------------------------------------------------------------------------------>
    </MudPaper>

</MudStack>

@code {
    public int? CartItemCount { get; set; } = 0; // Variable para trabajar el n° de productos en el carrito
    private bool HasItems => CartItemCount > 0;// Para controlar la visibilidad

    bool _drawerOpen = false;

    private bool _open;
    private Anchor _anchor;
    private bool _overlayAutoClose = true;

    private void OpenDrawer(Anchor anchor)
    {
        _open = true;
        _anchor = anchor;
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    protected override async Task OnInitializedAsync()
    {
        CartState.OnChange += async () => await LoadCartCount();
        await LoadCartCount();
    }

    public void Dispose()
    {
        CartState.OnChange -= async () => await LoadCartCount(); // Evitar fuga de memoria
    }

    public async Task LoadCartCount()
    {
        CartItemCount = await CartService.GetCartTotalItemsAsync();
        StateHasChanged();
    }

    private void GoToCart()
    {
        Navigation.NavigateTo("/shoppingcart");
    }
}
